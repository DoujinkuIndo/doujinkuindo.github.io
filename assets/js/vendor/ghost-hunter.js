/*
Last Updated: 2016年6月10日 11:07:01

COTA
http://cota.jp
*/
(function(c){var b=function(d){var f=new b.Index;return f.pipeline.add(b.stopWordFilter,b.stemmer),d&&d.call(f,f),f};b.version="0.4.3","undefined"!=typeof module&&(module.exports=b),b.utils={},b.utils.warn=function(d){return function(f){d.console&&console.warn&&console.warn(f)}}(this),b.utils.zeroFillArray=function(){var d=[0];return function(f){for(;f>d.length;){d=d.concat(d)}return d.slice(0,f)}}(),b.EventEmitter=function(){this.events={}},b.EventEmitter.prototype.addListener=function(){var d=Array.prototype.slice.call(arguments),f=d.pop(),g=d;if("function"!=typeof f){throw new TypeError("last argument must be a function")}g.forEach(function(e){this.hasHandler(e)||(this.events[e]=[]),this.events[e].push(f)},this)},b.EventEmitter.prototype.removeListener=function(d,f){if(this.hasHandler(d)){var g=this.events[d].indexOf(f);this.events[d].splice(g,1),this.events[d].length||delete this.events[d]}},b.EventEmitter.prototype.emit=function(d){if(this.hasHandler(d)){var f=Array.prototype.slice.call(arguments,1);this.events[d].forEach(function(e){e.apply(void 0,f)})}},b.EventEmitter.prototype.hasHandler=function(d){return d in this.events},b.tokenizer=function(d){if(!arguments.length||null==d||void 0==d){return[]}if(Array.isArray(d)){return d.map(function(e){return e.toLowerCase()})}for(var f=(""+d).replace(/^\s+/,""),g=f.length-1;g>=0;g--){if(/\S/.test(f.charAt(g))){f=f.substring(0,g+1);break}}return f.split(/\s+/).map(function(e){return e.replace(/^\W+/,"").replace(/\W+$/,"").toLowerCase()})},b.Pipeline=function(){this._stack=[]},b.Pipeline.registeredFunctions={},b.Pipeline.registerFunction=function(d,f){f in this.registeredFunctions&&b.utils.warn("Overwriting existing registered function: "+f),d.label=f,b.Pipeline.registeredFunctions[d.label]=d},b.Pipeline.warnIfFunctionNotRegistered=function(d){var f=d.label&&d.label in this.registeredFunctions;f||b.utils.warn("Function is not registered with pipeline. This may cause problems when serialising the index.\n",d)},b.Pipeline.load=function(d){var f=new b.Pipeline;return d.forEach(function(e){var g=b.Pipeline.registeredFunctions[e];if(!g){throw Error("Cannot load un-registered function: "+e)}f.add(g)}),f},b.Pipeline.prototype.add=function(){var d=Array.prototype.slice.call(arguments);d.forEach(function(e){b.Pipeline.warnIfFunctionNotRegistered(e),this._stack.push(e)},this)},b.Pipeline.prototype.after=function(d,f){b.Pipeline.warnIfFunctionNotRegistered(f);var g=this._stack.indexOf(d)+1;this._stack.splice(g,0,f)},b.Pipeline.prototype.before=function(d,f){b.Pipeline.warnIfFunctionNotRegistered(f);var g=this._stack.indexOf(d);this._stack.splice(g,0,f)},b.Pipeline.prototype.remove=function(d){var f=this._stack.indexOf(d);this._stack.splice(f,1)},b.Pipeline.prototype.run=function(f){for(var j=[],l=f.length,h=this._stack.length,k=0;l>k;k++){for(var d=f[k],g=0;h>g&&(d=this._stack[g](d,k,f),void 0!==d);g++){}void 0!==d&&j.push(d)}return j},b.Pipeline.prototype.toJSON=function(){return this._stack.map(function(d){return b.Pipeline.warnIfFunctionNotRegistered(d),d.label})},b.Vector=function(d){this.elements=d},b.Vector.prototype.magnitude=function(){if(this._magnitude){return this._magnitude}for(var d,g=0,i=this.elements,f=i.length,h=0;f>h;h++){d=i[h],g+=d*d}return this._magnitude=Math.sqrt(g)},b.Vector.prototype.dot=function(f){for(var h=this.elements,k=f.elements,g=h.length,j=0,d=0;g>d;d++){j+=h[d]*k[d]}return j},b.Vector.prototype.similarity=function(d){return this.dot(d)/(this.magnitude()*d.magnitude())},b.Vector.prototype.toArray=function(){return this.elements},b.SortedSet=function(){this.length=0,this.elements=[]},b.SortedSet.load=function(d){var f=new this;return f.elements=d,f.length=d.length,f},b.SortedSet.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(d){~this.indexOf(d)||this.elements.splice(this.locationFor(d),0,d)},this),this.length=this.elements.length},b.SortedSet.prototype.toArray=function(){return this.elements.slice()},b.SortedSet.prototype.map=function(d,f){return this.elements.map(d,f)},b.SortedSet.prototype.forEach=function(d,f){return this.elements.forEach(d,f)},b.SortedSet.prototype.indexOf=function(f,h,k){var h=h||0,k=k||this.elements.length,g=k-h,j=h+Math.floor(g/2),d=this.elements[j];return 1>=g?d===f?j:-1:f>d?this.indexOf(f,j,k):d>f?this.indexOf(f,h,j):d===f?j:void 0},b.SortedSet.prototype.locationFor=function(f,h,k){var h=h||0,k=k||this.elements.length,g=k-h,j=h+Math.floor(g/2),d=this.elements[j];if(1>=g){if(d>f){return j}if(f>d){return j+1}}return f>d?this.locationFor(f,j,k):d>f?this.locationFor(f,h,j):void 0},b.SortedSet.prototype.intersect=function(g){for(var k=new b.SortedSet,p=0,j=0,m=this.length,f=g.length,h=this.elements,d=g.elements;;){if(p>m-1||j>f-1){break}h[p]!==d[j]?h[p]<d[j]?p++:h[p]>d[j]&&j++:(k.add(h[p]),p++,j++)}return k},b.SortedSet.prototype.clone=function(){var d=new b.SortedSet;return d.elements=this.toArray(),d.length=d.elements.length,d},b.SortedSet.prototype.union=function(d){var g,h,f;return this.length>=d.length?(g=this,h=d):(g=d,h=this),f=g.clone(),f.add.apply(f,h.toArray()),f},b.SortedSet.prototype.toJSON=function(){return this.toArray()},b.Index=function(){this._fields=[],this._ref="id",this.pipeline=new b.Pipeline,this.documentStore=new b.Store,this.tokenStore=new b.TokenStore,this.corpusTokens=new b.SortedSet,this.eventEmitter=new b.EventEmitter,this._idfCache={},this.on("add","remove","update",function(){this._idfCache={}}.bind(this))},b.Index.prototype.on=function(){var d=Array.prototype.slice.call(arguments);return this.eventEmitter.addListener.apply(this.eventEmitter,d)},b.Index.prototype.off=function(d,f){return this.eventEmitter.removeListener(d,f)},b.Index.load=function(d){d.version!==b.version&&b.utils.warn("version mismatch: current "+b.version+" importing "+d.version);var f=new this;return f._fields=d.fields,f._ref=d.ref,f.documentStore=b.Store.load(d.documentStore),f.tokenStore=b.TokenStore.load(d.tokenStore),f.corpusTokens=b.SortedSet.load(d.corpusTokens),f.pipeline=b.Pipeline.load(d.pipeline),f},b.Index.prototype.field=function(d,f){var f=f||{},g={name:d,boost:f.boost||1};return this._fields.push(g),this},b.Index.prototype.ref=function(d){return this._ref=d,this},b.Index.prototype.add=function(g,k){var p={},j=new b.SortedSet,m=g[this._ref],k=void 0===k?!0:k;this._fields.forEach(function(i){var l=this.pipeline.run(b.tokenizer(g[i.name]));p[i.name]=l,b.SortedSet.prototype.add.apply(j,l)},this),this.documentStore.set(m,j),b.SortedSet.prototype.add.apply(this.corpusTokens,j.toArray());for(var f=0;j.length>f;f++){var h=j.elements[f],d=this._fields.reduce(function(i,n){var l=p[n.name].length;if(!l){return i}var q=p[n.name].filter(function(e){return e===h}).length;return i+q/l*n.boost},0);this.tokenStore.add(h,{ref:m,tf:d})}k&&this.eventEmitter.emit("add",g,this)},b.Index.prototype.remove=function(d,g){var h=d[this._ref],g=void 0===g?!0:g;if(this.documentStore.has(h)){var f=this.documentStore.get(h);this.documentStore.remove(h),f.forEach(function(e){this.tokenStore.remove(e,h)},this),g&&this.eventEmitter.emit("remove",d,this)}},b.Index.prototype.update=function(d,f){var f=void 0===f?!0:f;this.remove(d,!1),this.add(d,!1),f&&this.eventEmitter.emit("update",d,this)},b.Index.prototype.idf=function(d){if(this._idfCache[d]){return this._idfCache[d]}var f=this.tokenStore.count(d),g=1;return f>0&&(g=1+Math.log(this.tokenStore.length/f)),this._idfCache[d]=g},b.Index.prototype.search=function(g){var k=this.pipeline.run(b.tokenizer(g)),p=b.utils.zeroFillArray(this.corpusTokens.length),j=[],m=this._fields.reduce(function(i,l){return i+l.boost},0),f=k.some(function(e){return this.tokenStore.has(e)},this);if(!f){return[]}k.forEach(function(r,w,q){var v=1/q.length*this._fields.length*m,n=this,o=this.tokenStore.expand(r).reduce(function(z,y){var A=n.corpusTokens.indexOf(y),t=n.idf(y),s=1,l=new b.SortedSet;if(y!==r){var x=Math.max(3,y.length-r.length);s=1/Math.log(x)}return A>-1&&(p[A]=v*t*s),Object.keys(n.tokenStore.get(y)).forEach(function(e){l.add(e)}),z.union(l)},new b.SortedSet);j.push(o)},this);var h=j.reduce(function(i,l){return i.intersect(l)}),d=new b.Vector(p);return h.map(function(e){return{ref:e,score:d.similarity(this.documentVector(e))}},this).sort(function(i,l){return l.score-i.score})},b.Index.prototype.documentVector=function(g){for(var k=this.documentStore.get(g),p=k.length,j=b.utils.zeroFillArray(this.corpusTokens.length),m=0;p>m;m++){var f=k.elements[m],h=this.tokenStore.get(f)[g].tf,d=this.idf(f);j[this.corpusTokens.indexOf(f)]=h*d}return new b.Vector(j)},b.Index.prototype.toJSON=function(){return{version:b.version,fields:this._fields,ref:this._ref,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},b.Store=function(){this.store={},this.length=0},b.Store.load=function(d){var f=new this;return f.length=d.length,f.store=Object.keys(d.store).reduce(function(g,h){return g[h]=b.SortedSet.load(d.store[h]),g},{}),f},b.Store.prototype.set=function(d,f){this.store[d]=f,this.length=Object.keys(this.store).length},b.Store.prototype.get=function(d){return this.store[d]},b.Store.prototype.has=function(d){return d in this.store},b.Store.prototype.remove=function(d){this.has(d)&&(delete this.store[d],this.length--)},b.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},b.stemmer=function(){var q={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},k={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},g="[^aeiou]",d="[aeiouy]",f=g+"[^aeiouy]*",j=d+"[aeiou]*",v="^("+f+")?"+j+f,h="^("+f+")?"+j+f+"("+j+")?$",p="^("+f+")?"+j+f+j+f,m="^("+f+")?"+d;return function(l){var r,s,w,e,t,u,x;if(3>l.length){return l}if(w=l.substr(0,1),"y"==w&&(l=w.toUpperCase()+l.substr(1)),e=/^(.+?)(ss|i)es$/,t=/^(.+?)([^s])s$/,e.test(l)?l=l.replace(e,"$1$2"):t.test(l)&&(l=l.replace(t,"$1$2")),e=/^(.+?)eed$/,t=/^(.+?)(ed|ing)$/,e.test(l)){var o=e.exec(l);e=RegExp(v),e.test(o[1])&&(e=/.$/,l=l.replace(e,""))}else{if(t.test(l)){var o=t.exec(l);r=o[1],t=RegExp(m),t.test(r)&&(l=r,t=/(at|bl|iz)$/,u=RegExp("([^aeiouylsz])\\1$"),x=RegExp("^"+f+d+"[^aeiouwxy]$"),t.test(l)?l+="e":u.test(l)?(e=/.$/,l=l.replace(e,"")):x.test(l)&&(l+="e"))}}if(e=/^(.+?)y$/,e.test(l)){var o=e.exec(l);r=o[1],e=RegExp(m),e.test(r)&&(l=r+"i")}if(e=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,e.test(l)){var o=e.exec(l);r=o[1],s=o[2],e=RegExp(v),e.test(r)&&(l=r+q[s])}if(e=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,e.test(l)){var o=e.exec(l);r=o[1],s=o[2],e=RegExp(v),e.test(r)&&(l=r+k[s])}if(e=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,t=/^(.+?)(s|t)(ion)$/,e.test(l)){var o=e.exec(l);r=o[1],e=RegExp(p),e.test(r)&&(l=r)}else{if(t.test(l)){var o=t.exec(l);r=o[1]+o[2],t=RegExp(p),t.test(r)&&(l=r)}}if(e=/^(.+?)e$/,e.test(l)){var o=e.exec(l);r=o[1],e=RegExp(p),t=RegExp(h),u=RegExp("^"+f+d+"[^aeiouwxy]$"),(e.test(r)||t.test(r)&&!u.test(r))&&(l=r)}return e=/ll$/,t=RegExp(p),e.test(l)&&t.test(l)&&(e=/.$/,l=l.replace(e,"")),"y"==w&&(l=w.toLowerCase()+l.substr(1)),l}}(),b.Pipeline.registerFunction(b.stemmer,"stemmer"),b.stopWordFilter=function(d){return -1===b.stopWordFilter.stopWords.indexOf(d)?d:void 0},b.stopWordFilter.stopWords=new b.SortedSet,b.stopWordFilter.stopWords.length=119,b.stopWordFilter.stopWords.elements=["","a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"],b.Pipeline.registerFunction(b.stopWordFilter,"stopWordFilter"),b.TokenStore=function(){this.root={docs:{}},this.length=0},b.TokenStore.load=function(d){var f=new this;return f.root=d.root,f.length=d.length,f},b.TokenStore.prototype.add=function(d,g,i){var i=i||this.root,f=d[0],h=d.slice(1);return f in i||(i[f]={docs:{}}),0===h.length?(i[f].docs[g.ref]=g,this.length+=1,void 0):this.add(h,g,i[f])},b.TokenStore.prototype.has=function(d){if(!d){return !1}for(var f=this.root,g=0;d.length>g;g++){if(!f[d[g]]){return !1}f=f[d[g]]}return !0},b.TokenStore.prototype.getNode=function(d){if(!d){return{}}for(var f=this.root,g=0;d.length>g;g++){if(!f[d[g]]){return{}}f=f[d[g]]}return f},b.TokenStore.prototype.get=function(d,f){return this.getNode(d,f).docs||{}},b.TokenStore.prototype.count=function(d,f){return Object.keys(this.get(d,f)).length},b.TokenStore.prototype.remove=function(d,g){if(d){for(var h=this.root,f=0;d.length>f;f++){if(!(d[f] in h)){return}h=h[d[f]]}delete h.docs[g]}},b.TokenStore.prototype.expand=function(d,g){var h=this.getNode(d),f=h.docs||{},g=g||[];return Object.keys(f).length&&g.push(d),Object.keys(h).forEach(function(e){"docs"!==e&&g.concat(this.expand(d+e,g))},this),g},b.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}};c.fn.ghostHunter=function(d){var e=c.extend({},c.fn.ghostHunter.defaults,d);if(e.results){a.init(this,e);return a}};c.fn.ghostHunter.defaults={results:false,rss:"/rss",onKeyUp:false,result_template:"<a href='{{link}}'><p><h2>{{title}}</h2><h4>{{pubDate}}</h4></p></a>",info_template:"<p>Number of posts found: {{amount}}</p>",displaySearchInfo:true,zeroResultsInfo:true,before:false,onComplete:false};var a={isInit:false,init:function(f,e){var d=this;this.target=f;this.rss=e.rss;this.results=e.results;this.blogData=[];this.result_template=e.result_template;this.info_template=e.info_template;this.zeroResultsInfo=e.zeroResultsInfo;this.displaySearchInfo=e.displaySearchInfo;this.before=e.before;this.onComplete=e.onComplete;this.index=b(function(){this.field("title",{boost:10});this.field("description");this.field("link");this.field("category");this.field("pubDate");this.ref("id")});f.focus(function(){d.loadRSS()});f.closest("form").submit(function(g){g.preventDefault();d.find(f.val())});if(e.onKeyUp){d.loadRSS();f.keyup(function(){d.find(f.val())})}},loadRSS:function(){if(this.isInit){return false}var f=this.index,e=this.rss,d=this.blogData;c.get(e,function(k){var j=c(k).find("item");for(var h=0;j&&h<j.length;h++){var g=j.eq(h);var l={id:h+1,title:g.find("title").text(),description:g.find("description").text(),category:g.find("category").text(),pubDate:g.find("pubDate").text(),link:g.find("link").text()};f.add(l);d.push(l)}});this.isInit=true},find:function(j){var d=this.index.search(j);var h=c(this.results);var f=[];h.empty();if(this.before){this.before()}if(this.zeroResultsInfo||d.length>0){if(this.displaySearchInfo){h.append(this.format(this.info_template,{amount:d.length}))}}for(var g=0;g<d.length;g++){var e=this.blogData[d[g].ref-1];h.append(this.format(this.result_template,e));f.push(e)}if(this.onComplete){this.onComplete(f)}},clear:function(){c(this.results).empty();this.target.val("")},format:function(e,f){return e.replace(/{{([^{}]*)}}/g,function(g,d){var h=f[d];return typeof h==="string"||typeof h==="number"?h:g})}}})(jQuery);