# ORM related

---

---

# SQLAlchemy

## Inspect output raw SQL

```python
# No .all() at the end
sql = db.query(ChatModel)
    .join(ChatModel.latest_training_request)
    .filter(
        ChatModel.corpus_map_id == c_id,
        TrainingRequest.status == TrainingRequestStatusEnum.trained
    )

# Or 
sql.statement
```

## Join table in filter

```python
db.query(ChatModel)
    .join(ChatModel.latest_training_request)
    .filter(
        ChatModel.corpus_map_id == c_id,
        TrainingRequest.status == TrainingRequestStatusEnum.trained
    )
    .all()
```

## Use same subquery in LEFT & Right

- Letâ€™s say we want to join 2 identical subquery

```python
subquery = (
      db.query(ChatModel, CorpusMap.corpus_id, TrainingRequest.finished_at)
      .select_from(ChatModel)
      .join(ChatModel.latest_training_request)
      .join(ChatModel.corpus_map)
      .filter(
          TrainingRequest.status == TrainingRequestStatusEnum.trained,
          CorpusMap.allocated_tenant_id == tenant_id,
          # Important: exclude the current deployed models
          ChatModel.id.not_in(exclude_model_ids)
      )
      .subquery()
  )
# Set alias for main and join query
main_alias = aliased(subquery)
compare_alias = aliased(subquery)
# Build main query at last
main_q = (
    # Only select fields from LEFT query
    db.query(main_alias)
    .select_from(main_alias)
    .join(
        compare_alias,
        # Here is the magic
        and_(
            main_alias.c.corpus_map_id == compare_alias.c.corpus_map_id,
            main_alias.c.finished_at < compare_alias.c.finished_at
        ),
        # It is a LEFT JOIN !!!
        isouter=True
    )
    # i.e. The latest record per corpus_map_id
    .filter(compare_alias.c.id.is_(None))
)
# Execute SQL, empty array if not found
raw_res = main_q.all()
# Convert each rows: sqlalchemy.engine.row.Row into dict
main_res = [v._asdict() for v in raw_res]
```