---
layout: post
title: Install CentOS7 and setup MIPS QEMU
---

MIPSというモノに触ったことが無かったところで、そういえばQEMUさんを使えばMIPSをx86上で試せるね、と気づいて試した時のメモ。
まずはCentOS7をざっくりインストールしてから、QEMU上でMIPSカーネルが実行できるところまで。

### CentOS7をインストールする

- Get CentOS7 Image from [riken mirror](http://ftp.riken.jp/Linux/centos/7/isos/x86_64/) ... CentOS-7-x86_64-DVD-1511.iso
- Get Xming from [Xming](http://osdn.jp/projects/sfnet_xming/downloads/Xming/6.9.0.31/Xming-6-9-0-31-setup.exe/)
- setup CentOS and X11 Port Fowarding

<!--break-->

```bash
$ sudo yum groupinstall Development Tools -y
$ sudo yum install git -y
$ sudo yum update -y
$ sudo reboot
$ sudo ibus-setup
$ vi .bashrc
# User specific aliases and functions
if [[ "${SSH_CONNECTION}" ]] ; then
  export GTK_IM_MODULE=ibus
  export XMODIFIERS=@im=ibus
  export QT_IM_MODULE=ibus
  export NO_AT_BRIDGE=1
  ibus-daemon -d -x

  LANG=C
fi
```

### QEMU環境の構築

- QEMUをgitで最新タグを取ってくる

```bash
$ git clone git://git.qemu-project.org/qemu.git
$ cd qemu
$ git checkout -b v2.7.0 tags/v2.7.0
$ git branch
  master
* v2.7.0
$ git log
```

- QEMUのビルドに必要なものを一通り入れていく

```bash
$ sudo yum install gcc* -y
$ sudo yum install glib* -y
$ sudo yum install zlib-devel -y
$ sudo yum install pixman-devel -y
$ sudo yum install gtk3-devel -y
```

- QEMUをMIPS用にconfigure

```bash
$ ./configure --cc=gcc --enable-gtk --target-list=mips-softmmu,mips64-softmmu,mips64el-softmmu,mipsel-softmmu,mips-linux-user,mips64-linux-user,mips64el-linux-user,mipsel-linux-user,mipsn32-linux-user,mipsn32el-linux-user
...
NUMA host support no
tcmalloc support  no
jemalloc support  no
avx2 optimization yes
```

- QEMUのビルドとインストール

```bash
$ make clean
$ make all -j 16
...
  LINK  mipsel-softmmu/qemu-system-mipsel
  LINK  mips64el-softmmu/qemu-system-mips64el
  LINK  mips-softmmu/qemu-system-mips
  LINK  mips64-softmmu/qemu-system-mips64
$ sudo make install
...
$ qemu-<TAB>
qemu-ga               qemu-mips64el         qemu-system-mips
qemu-img              qemu-mipsel           qemu-system-mips64
qemu-io               qemu-mipsn32          qemu-system-mips64el
qemu-mips             qemu-mipsn32el        qemu-system-mipsel
qemu-mips64           qemu-nbd
```

### MIPS Kernel + Userspace を実行してみる

既にコンパイルされているイメージでまずは試してみましょう。

- get kernel and userspace
- First, I try to exec wiz [Compiled Binary](https://people.debian.org/~aurel32/qemu/mips/)

```bash
$ wget https://people.debian.org/~aurel32/qemu/mips/debian_squeeeze...
$ wget https://people.debian.org/~aurel32/qemu/mips/vmlinux-...
$ file vmlinux-2.6.32-5-5kc-malta
vmlinux-2.6.32-5-5kc-malta: ELF 64-bit MSB executable, MIPS, MIPS64 version 1 (SYSV), statically linked, BuildID[sha1]=2ca38ab9dd56e9d746f9783d13796c232fff8219, with unknown capability 0x410000000f676e75 = 0x1000000070403, not stripped
$ file vmlinux-3.2.0-4-5kc-malta
vmlinux-3.2.0-4-5kc-malta: ELF 64-bit LSB executable, MIPS, MIPS64 version 1 (SYSV), statically linked, BuildID[sha1]=683fdcc12f4a56a3f39f12b7db264eb5a6b1f061, with unknown capability 0x756e670000000f41 = 0x304000000070100, not stripped
```

- start Kernel 2.6.32-5 (Only launch.)

```bash
$ qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-5kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -display gtk
```

- start Kernel 3.2.0-4
- Kernel 3.2.0-4 is Little endian binary, then we use qemu-system-mips64el

```bash
$ qemu-system-mips64el -M malta -kernel vmlinux-3.2.0-4-5kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append "root=/dev/sda1 console=tty0" -display gtk
```




