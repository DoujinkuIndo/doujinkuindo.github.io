---
layout: post
title: pibドライバを読む (第2回)
---

クリスマスイヴな今日ですが、幸いなことに第2回のこの記事を書くことができました。年末年始のお忙しい中、お疲れ様でございます。さて、Kernel Moduleを読み始める今回ですが、ドライバのソースコードを見回した際には、下記コマンドでエントリポイントを探しましょう。`module_init`マクロで指定した関数からKernel Moduleから開始します（そしてKernel Moduleが取り外される際に実行されるのが`module_exit`です）。

そのため、このpibは`pib_main.c`の`pib_init`関数( [here](https://github.com/xinolinx/pib/blob/master/driver/pib_main.c#L960) )から読み始めます。

```bash
$ git clone https://github.com/xinolinx/pib.git
$ cd pib/driver
$ find . -type f | xargs grep module_init
./pib_main.c:module_init(pib_init);
$ find . -type f | xargs grep module_exit
./pib_main.c:module_exit(pib_cleanup);
```
<!--break-->

`pib_init`関数の構造は主に、「Kernel Moduleへ渡した引数の検査」と「仮想InfiniBandデバイスの生成を開始」から構成されています。 [最初に出てくるif文節](https://github.com/xinolinx/pib/blob/master/driver/pib_main.c#L966) が引数検査に相当します。Kernel Moduleの引数は下記のようにKernel Moduleをinsmodする際に指定することができるものです。

```bash
$ sudo insmod pib.ko port=2
$ ibv_devinfo
hca_id: pib_0
        transport:                      InfiniBand (0)
        fw_ver:                         0.4.006
        node_guid:                      0013:3b0f:d42e:0300
        sys_image_guid:                 0013:3b0f:d42e:0200
        vendor_id:                      0x0001
        vendor_part_id:                 1
        hw_ver:                         0x0
        phys_port_cnt:                  2
                port:   1
                        state:                  PORT_ACTIVE (4)
                        max_mtu:                4096 (5)
                        active_mtu:             256 (1)
                        sm_lid:                 125
                        port_lid:               32001
                        port_lmc:               0x00
                        link_layer:             InfiniBand

                port:   2
                        state:                  PORT_ACTIVE (4)
                        max_mtu:                4096 (5)
                        active_mtu:             256 (1)
                        sm_lid:                 125
                        port_lid:               32002
                        port_lmc:               0x00
                        link_layer:             InfiniBand


```

どんな引数を与えられるか、その引数が内部変数のどれに相当するのかを決めているのが `module_param_named` マクロになります。 `module_param_named` マクロの第1引数がKernel Moduleへ指定できるパラメータ値名、第2引数が引数に指定された値が実際に格納されるKernel Module内部の変数名、第3引数が指定可能な型情報となり、第4引数が動的変更可能かどうかの指定値となります（ '/sys/module/pib/parameters/' ）。

```bash
$ find . -type f | xargs grep module_param_named
./pib_main.c:module_param_named(debug_level, pib_debug_level, int, 0644);
./pib_main.c:module_param_named(sm_lid, pib_const_sm_lid, uint, S_IRUGO);
./pib_main.c:module_param_named(glb_subnet_prefix, pib_const_global_sm_prefix, uint, S_IRUGO);
./pib_main.c:module_param_named(port, pib_phys_port_cnt, uint, S_IRUGO);
./pib_main.c:module_param_named(behavior, pib_behavior, uint, 0644);
./pib_main.c:module_param_named(manner_warn, pib_manner_warn, uint, 0644);
./pib_main.c:module_param_named(manner_err, pib_manner_err, uint, 0644);
./pib_thread.c:module_param_named(send_buffer_size, send_buffer_size, int, S_IRUGO);
./pib_thread.c:module_param_named(recv_buffer_size, recv_buffer_size, int, S_IRUGO);
./pib_thread.c:module_param_named(nice, pib_nice, int, 0644);
```

```bash
$ ls /sys/module/pib/parameters/
behavior     glb_subnet_prefix  manner_warn  port              send_buffer_size
debug_level  manner_err         nice         recv_buffer_size  sm_lid
```
これで開始関数と、引数情報が判ったので、次回はようやくコードを追い始めます。
