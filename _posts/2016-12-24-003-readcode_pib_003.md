---
layout: post
title: pibドライバを読む (第3回)
---

linuxでは `/sys/class` 以下にデバイス管理構造を保持します。pibでは `pib_init` 関数の `class_create(...)` 、 `device_create(...)` により `/sys/class/pib/pib_root/` が生成されます。なお、ここで `device_create(...)` にて生成される構造体は [struct device](http://lxr.free-electrons.com/source/include/linux/device.h?v=4.8#L709) で定義されます。

その後の `pib_dev_add(...)` 関数にて、pibを管理する構造体（InfiniBandデバイスを管理する構造体を含む）の初期化とLinuxへのデバイス登録を行います。
<!--break-->
InfiniBandデバイス管理する構造体は [dev.ib_dev](https://github.com/xinolinx/pib/blob/master/driver/pib_main.c#L399) への値の代入で初期化されています。構造体の代入では、 `uverbs_cmd_mask` にて設定したフラグがInfiniBandを制御するuverbsというInterfaceのどの処理を受け取るかを選択し、以降に続く関数ポインタの代入により、uverbsを介してpib Kernel Moduleが呼び出された際に、開始される関数を設定することができます。

```bash
	dev->ib_dev.uverbs_cmd_mask	=
	        ...
		(1ULL << IB_USER_VERBS_CMD_QUERY_DEVICE)	|
		(1ULL << IB_USER_VERBS_CMD_QUERY_PORT)		|
                ...

	dev->ib_dev.query_device	= pib_query_device;
	dev->ib_dev.query_port		= pib_query_port;
        ...
```

続けて、Kernel Module内部で利用する変数を初期化していきます。 [このあたり](https://github.com/xinolinx/pib/blob/master/driver/pib_main.c#L550) はInfiniBand固有処理ではないため、ここでは省略します。主にLinked Listの初期化やLockの初期化を行っています。

最後にInifiniBandのport管理構造体を初期化します。port管理構造体はInfiniBand管理構造体 `dev->ports` 以下にポート数分の配列を定義します。なお、ポート数は `dev->ib_dev.phys_port_cnt` で指定しています。

ポートの初期化と、実際のデバイスの登録は次回以降にしたいと思います。

それでは、良い夜をお過ごしください。
