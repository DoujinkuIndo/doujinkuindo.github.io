---
layout: post
title: WOL wiz Windows10 (その1)
---

iPhoneのMusicライブラリをお持ちの皆さまはiTunesで音楽管理されていることが多いかと思います。
また、リビングダイニングに設置されたオーディオ環境でiTunesを使われる際は、[iTunes Remote](https://itunes.apple.com/jp/app/itunes-remote/id284417350?mt=8)を利用することで、
ソファーや食卓から、キーボード・マウスを触らずに曲を切り替えるができますので、非常に便利です。
寝室に行く前に[Remote Mouse](https://www.remotemouse.net/)で休止状態・シャットダウン、というのも良いでしょう。

となりますと、最後は「遠隔からPCの電源ON」をしたくなり、
勿論、MagicPacketによるWOL（Wake-On-LAN）が良い解決策かと思います。
私は[RemoteBoot WOL](https://itunes.apple.com/jp/app/remoteboot-wol/id310369182?mt=8)を導入しています。
2台のPC(Linux機とWindows機)をセットアップしましたが、Windows機側でハマったのでメモしておきます。

<!--break-->

なお、双方とも[RemoteBoot WOL](https://itunes.apple.com/jp/app/remoteboot-wol/id310369182?mt=8)側の設定は以下となります。

| 設定項目 | 設定値 | 備考 |
|:---------|:------:|:-----|
|Name      | (任意) | |
|MAC       | xx:xx:xx:xx:xx:xx | 起動用NIC(有線)のMACアドレス |
|Broadcast | ON     | |
|IP        | 255.255.255.255 | |
|Port      | 50000  | |

#### Linux機

**M/B:ASlock H110-ITX/D3**

- **BIOS設定**
 - *ACPI Configuration*
  - Suspent to RAM : Auto
  - ACPI HPET Table : Enable
  - PCIE Device Power On : Enable
 - *Chipset Configuration*
  - PCIE ASPM Support : Enable
  - PCH PCIE ASPM Support : Enable
  - DMI ASPM Support : Enable
  - PCH DMI ASPM Support : Enable
  - On Board LAN : Enable
  - Boot From Onboard LAN : Disable

上記設定の状態にて、電源OFF(ACコンセント有)時にLANポートがLink-UpしていればWOL-Magic-Packetを受信可能です。
なお、Linux上で実際にMagic-Packetを受け取る場合は下記のコマンドにて確認可能です。
ここでは iPhone のIP Address(Wi-Fi->アクセスポイント名横のi)を 192.168.0.15 としています。

```bash
$ sudo tcpdump host 192.168.0.15 -i enp0s31f6 -e -P in -x -vv
tcpdump: listening on enp0s31f6, link-type EN10MB (Ethernet), capture size 65535 bytes
00:45:29.902976 38:71:de:ae:52:f6 (oui Unknown) > Broadcast, ethertype IPv4 (0x0800), length 144: (tos 0x0, ttl 64, id 41084, offset 0, flags [none], proto UDP (17), length 130)
    192.168.0.15.59705 > 255.255.255.255.50000: [udp sum ok] UDP, length 102
        0x0000:  4500 0082 a07c 0000 4011 1938 c0a8 000f
        0x0010:  ffff ffff e939 c350 006e aee8 ffff ffff
        0x0020:  ffff d050 9985 1458 d050 9985 1458 d050
        0x0030:  9985 1458 d050 9985 1458 d050 9985 1458
        0x0040:  d050 9985 1458 d050 9985 1458 d050 9985
        0x0050:  1458 d050 9985 1458 d050 9985 1458 d050
        0x0060:  9985 1458 d050 9985 1458 d050 9985 1458
        0x0070:  d050 9985 1458 d050 9985 1458 d050 9985
        0x0080:  1458
```

`tcpdump`は`-i`によるインタフェース指定や、`host`による対向ノードの指定、`-P`によるdirectionを指定し計画的にキャプチャします。これらの設定を省略してしまいますと、SSHやARP、他ノードのサービス探査のブロードキャストパケットにより直ぐに画面が埋まってしまいますので（思った以上に自宅も流れていて驚きました:P）。

#### Windows機

**M/B:ASUS H110M-A/M.2**

- **BIOS設定**
 - *APM Configuration*
  - ErP Ready : Enabled(S4+S5)
  - PowerOn By PCI-E : Enabled
 - *Platform Misc Configuration*
  - PCI Express Native Power Management : Enabled
  - Native ASPM : Auto
  - DMI Link ASPM Control : Enabled
  - ASPM Support : Auto
  - DMI Link ASPM Control : L1
  - PEG - ASPM : Auto
 - *OnBoard Device Configuration*
  - Intel LAN Controller : Enable
  - Intel PXE Option ROM : OFF

上記設定の後、UEFI内で電源OFF(ACコンセント有)とすると、LANポートがLink-UpしてWOL-Magic-Packetを受信可能になります。
が、現状、Windows10 Proよりシャットダウンを選択しますと、S4+S5で止まらずにPCI-Expressの電源供給が止まってしまい、
LANポートがLink-DownしWOL-Magic-Packetを受信できず、WOLが利用できませんでした。
回避策として「休止状態」を利用し、S4で止めておく、という対応をしています。
[Remote Mouse](https://www.remotemouse.net/)ではSleepを選択すると、休止状態となってくれました。

なお、Windows上でWOLが到達しているかどうかの確認には[WireShark](https://www.wireshark.org/download.html)を利用しました。

また後日、Windowsの挙動については調べてみようと思います。
