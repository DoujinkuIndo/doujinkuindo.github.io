---
layout: post
title: Mutex
tags: [golang, concurrency, select, channel, buffered channnel, workder pools]
---

## Critical section
Định nghĩa `critical section` trong lập trình concurrent: Khi chương trình đang chạy, một phần đoạn code có thể thay đổi resource dùng chung thì không nên được access bởi nhiều Goroutines tại cùng một thời điểm. Đoạn code modifies shared resource được gọi là critical section. 

Ví dụ, ta có đoạn code cập nhật giá trị của `x` như sau:
```go
x = x + 1
```
Nếu chỉ có một Goroutine truy cập => không có vấn đề gì xảy ra nhưng giả sử có 2 Goroutine cùng chạy đoạn code trên concurently.

Đoạn code trên khi được executed bởi system sẽ được chia nhỏ ra thành những step sau(có thể có nhiều step hơn nhưnng hay giả sử có 3 steps sau)
```
1. Lấy giá trị hiện tại của x
2. Tính toán x + 1
3. Gán gía trị của step 2 vào x
```
Hình minh hoạ nếu có 2 Goroutine chạy cùng một lúc vô critital resource

![_config.yml]({{ site.baseurl }}/images/cs5.png)


Trong trường hợp trên giả sử giá trị ban đầu của `x` là 0, Goroutine 1 bắt đầu thực thi, lấy giá trị ban đầu của `x`, tính toán `x+1` và trước khi gán lại gía trị mới cho `x` system chuyển qua Goroutine 2. Bây giờ Goroutine 2 lấy giá trị ban đầu của `x`, vẫn là 0, tăng lên thành 1. Sau đó, system switch lại về Goroutin 1. Bây giờ,  Goroutine 1 gán giá trị 1 cho `x`, và `x` có giá trị 1. Sau đó, Goroutine 2 tiếp tục thực thi và gán gía trị mà nó tính toán, `1`, cho `x`. Sau khi cả 2 Goroutine chay, `x` vẫn mang giá trị 1. 

![_config.yml]({{ site.baseurl }}/images/cs-6.png)
Trong kịch bản sau, Goroutine 1 chạy và kết thúc 3 steps, tăng giá trị lên của `x` lên 1. Sau đó, Goroutine 2 mới thực thi, bây giờ giá trị của `x` là 1, Goroutine 2 tăng thêm `+1` và kết thúc. Giá trị cuối cùng của `x` là 2. 

Từ 2 kịch bản trên, giá trị cuối cùng của `x` có thể là 1 hoặc 2, phụ thuộc vào cách system switch giữa các Goroutinne. Nó được gọi là `race condition`.

Trong ví dụ trên nếu race conditon có thể tránh được nếu chỉ một Goroutine được cho phép truy cập vào critical section tại bất kì thời điểm nào. Go có thể làm việc đó bằng cách sử dụng `Mutex`.


