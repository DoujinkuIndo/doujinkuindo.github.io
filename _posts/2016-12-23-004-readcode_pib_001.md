---
layout: post
title: pibドライバを読む (第1回)
---

僕がGitHubにforkしています [pib](https://github.com/xinolinx/pib) のコードを読んでいきたいと思います。第1回と書きましたが、特に何回までやるか決めていないので、僕のモチベーションがある間続くといいなと思っています。

さて、pib は Pesudo InfiniBand の略で作者様がethernet環境でもInfiniBandを触れるように (InfiniBand Verbs:IBV-Verbs) をソフトウェアで定義した、仮想デバイスを見せるKernel Module　(*.ko) です。
<!--break-->

Kernel Module 初めてな方から見ると、OS空間で実行されている断片的なプログラムをイメージしていただくのが一番近いかと思います。Kernel ModuleはKernelもしくは別のKernel Moduleが提供している関数を呼び出す事が可能で、この連携を利用して、デバイスをOSへ登録することにより、ユーザ（Terminal or GUI）からデバイスが見えるという形になります。ユーザが見えているデバイスを操作すれば、これがKernelに通知され、KernelがKernel Moduleの機能を呼び出し、実際のハードウェアを制御したり、今回のpibであればInfiniBand要求をethernetパケットに変換して送出する、という流れになります。

完全なpibのKernel Moduleはfork元を参照頂くとして、僕はどのようにInfiniBandとして見せているのか、という観点で話を進めていきたく思います。そのため、本来のpibに存在していたethernet通信部はすべて除去し、デバッグ機能、トレース機能も除去したものが、僕のリポジトリのmasterに上がっています。また、後程話が出てきますが、InfiniBandアーキテクチャに存在するSubnet-Managerとの会話機能（Subnet-Manager Agent）も簡略化のために除外してみました。そのため、実際に通信することも、デバイスとして何かすることもできませんが、 `ibv_devinfo` コマンド（ `yum install libibverbs-utils` が提供 ）でデバイスが見えるだけの状態にしたKernel Moduleをまずは作っています。

```bash
$ sudo insmod pib.ko
$ ibv_devinfo
hca_id: pib_0
        transport:                      InfiniBand (0)
        fw_ver:                         0.4.006
        node_guid:                      0013:3b0f:d42e:0300
        sys_image_guid:                 0013:3b0f:d42e:0200
        vendor_id:                      0x0001
        vendor_part_id:                 1
        hw_ver:                         0x0
        phys_port_cnt:                  1
                port:   1
                        state:                  PORT_ACTIVE (4)
                        max_mtu:                4096 (5)
                        active_mtu:             256 (1)
                        sm_lid:                 125
                        port_lid:               32001
                        port_lmc:               0x00
                        link_layer:             InfiniBand

```

なお、これまでethernetを利用して通信していた箇所は [pib_rdev.c](https://github.com/xinolinx/pib/blob/master/driver/pib_rdev.c) にまとめて空関数にしています（通信機能はない）。

- 通信パケットが送出される機能 `rdev_sendmsg` [here](https://github.com/xinolinx/pib/blob/master/driver/pib_rdev.c#L139)
- 通信パケットを受信する機能 `rdev_recvmsg` [here](https://github.com/xinolinx/pib/blob/master/driver/pib_rdev.c#L128)

では、以上を前提に第2回から、実際にコードを読み始めたいと思います。
